{% extends "base.html" %}

{% block content %}
<h1>{{ts["title"]}}{{ toilet.toilet_id }} ({{toilet.location_str}})</h1>

<!-- Map container -->
<div id="map"></div>

<!-- Toilet details -->
<p><strong>{{ts["address"]}}</strong> {{toilet.address}} <br> <strong>{{ts["location"]}}</strong> {{ts["latitude"]}} {{ toilet.latitude }}, {{ts["longitude"]}} {{ toilet.longitude }}</p>

<!-- Average Ratings -->
<h2>Average Ratings:</h2>
<ul>
    <li><strong>{{ts["cleanliness"]}}</strong> {{ toilet.avg_cleanliness | round(2) }}</li>
    <li><strong>{{ts["supplies"]}}</strong> {{ toilet.avg_supplies | round(2) }}</li>
    <li><strong>{{ts["privacy"]}}</strong> {{ toilet.avg_privacy | round(2) }}</li>
</ul>

<h2>Ratings:</h2>
<ul>
    {% for rating in toilet.ratings %}
        <li>
            <a href="/profile/{{ rating.username }}"><strong>@{{ rating.username }}</strong>:</a>
            {{ts["cleanliness"]}}: {{ rating.cleanliness }},
            {{ts["supplies"]}}: {{ rating.supplies }},
            {{ts["privacy"]}}: {{ rating.privacy }},
            {{ts["comment"]}}: "{% if '@' in rating.comment %}{{ rating.comment | replace('@' + rating.comment.split('@')[1].split(' ')[0], '<a class="at-mention" href=\"/profile/' + rating.comment.split('@')[1].split(' ')[0] + '\">@' + rating.comment.split('@')[1].split(' ')[0] + '</a>') | safe }}{% else %}{{ rating.comment }}{% endif %}"
        </li>
    {% endfor %}
</ul>

<script>
    // Create the map
    var map = L.map('map').setView([{{ toilet.latitude }}, {{ toilet.longitude }}], 13); // Set map view to toilet coordinates

    // Set the tile Layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Add a marker for the toilet location
    var marker = L.marker([{{ toilet.latitude }}, {{ toilet.longitude }}]).addTo(map);
    marker.bindPopup("<b>Toilet #{{ toilet.toilet_id }}</b><br>Location: {{ toilet.latitude }}, {{ toilet.longitude }}").openPopup();

    // Initialize markers and variables for fetching additional toilets
    var markers = {};
    var lastLoadedId = 0;
    var loading = false;

    function fetchToiletsChunk() {
        if (loading) return;
        loading = true;

        // Fetching 50 toilets at max
        fetch(`/api/toilets?start_id=${lastLoadedId}&limit=50`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    data.forEach(function(toilet) {
                        if (!markers[toilet.toilet_id]) {
                            var marker = L.marker([toilet.latitude, toilet.longitude])
                                .addTo(map)
                                .bindPopup('Toilet ID: ' + toilet.toilet_id);

                            marker.on('click', function() {
                                window.location.href = '/toilet/' + toilet.toilet_id;
                            });

                            markers[toilet.toilet_id] = marker;
                        }
                    });
                    lastLoadedId = data[data.length - 1].toilet_id;
                }
                loading = false;
            })
            .catch(error => {
                console.error('Error fetching toilet data:', error);
                loading = false;
            });
    }

    fetchToiletsChunk();

    map.on('moveend', function() {
        fetchToiletsChunk();
    });
</script>

{% endblock %}

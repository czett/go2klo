{% extends "base.html" %}

{% block content %}
<h1 class="explore-title">{{ts["title"]}}</h1>
<div class="map-tip">{{ts["tip"]}}</div>
<div id="map"></div>

<div class="toilets-list">
    {% for toilet in toilets %}
    <a href="/toilet/{{toilet['toilet_id']}}">
        <div class="toilet">
            <!-- <div class="name">{{ts["toilet"]}} {{toilet["toilet_id"]}}</div> -->
            <div class="toilet-data">
                <div class="name">{{toilet["location_str"]}} (#{{toilet["toilet_id"]}})</div>
                <div class="coords">{{ts["coords"]}}: {{toilet["latitude"]}}, {{toilet["longitude"]}}</div>
                <div class="ratings">{{ts["ratings"]}}: {{toilet["rating_count"]}}</div>
            </div>
            <div class="toilet-icon">
                {% if toilet.rating_count >= 3 %}
                <span class="material-symbols-rounded" style="opacity: 1; filter: saturate(1);">diamond</span>
                {% elif toilet.rating_count >= 2 %}
                <span class="material-symbols-rounded" style="opacity: 0.6; filter: saturate(0.6);">hotel_class</span>
                {% else %}
                <span class="material-symbols-rounded" style="opacity: 0.2; filter: saturate(0);">star</span>
                {% endif %}
            </div>
        </div>
    </a>
    {% endfor %}
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map', {
        zoomControl: false // Hier wird das Zoom-Steuerelement deaktiviert
    }).setView([51.1657, 10.4515], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var markers = {};
    var lastLoadedId = 0;
    var loading = false;

    function fetchToiletsChunk() {
        if (loading) return;
        loading = true;

        // fetching 50 toilets at max :o
        fetch(`/api/toilets?start_id=${lastLoadedId}&limit=50`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    data.forEach(function(toilet) {
                        if (!markers[toilet.toilet_id]) {
                            var marker = L.marker([toilet.latitude, toilet.longitude])
                                .addTo(map)
                                .bindPopup('Toilet ID: ' + toilet.toilet_id);

                            marker.on('click', function() {
                                window.location.href = '/toilet/' + toilet.toilet_id;
                            });

                            markers[toilet.toilet_id] = marker;
                        }
                    });
                    lastLoadedId = data[data.length - 1].toilet_id;
                }
                loading = false;
            })
            .catch(error => {
                console.error('Error fetching toilet data:', error);
                loading = false;
            });
    }

    fetchToiletsChunk();

    map.on('moveend', function() {
        fetchToiletsChunk();
    });
</script>

{% endblock %}
